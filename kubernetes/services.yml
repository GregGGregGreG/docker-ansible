zone-green: &green
  nodeSelector:
    zone: green

zone-orange: &orange
  nodeSelector:
    zone: orange

secrets:
  - name: ssh-key-secret
    data:
      id-rsa: "dmFsdWUtMg0KDQo="
      id-rsa.pub: "dmFsdWUtMQ0K"

configmaps:
  - name: global
    data:
      node-env: production
      etcd-host: "{{ ETCD_HOST }}"
      zookeeper: zookeeper:2181
      tz: EST

volumes:
  - {name: log, emptyDir: {}}

volumeMounts:
  - {name: log, mountPath: /var/log}

sidecars:
  - name: fluentd-kafka
    image: tristar:5000/fluentd-kafka:latest
    imagePullPolicy: Always
    volumeMounts:
      - {name: log, mountPath: /var/log}
  - name: fluentd-graylog
    image: tristar:5000/fluentd-graylog:latest
    imagePullPolicy: Always
    volumeMounts:
      - {name: log, mountPath: /var/log}
    env:
      - {name: GRAYLOG_HOST, value: "graylog"}
      - {name: GRAYLOG_PORT, value: "12201"}

daemonsets:
  - name: zabbix-agent
    hostNetwork: true
    hostPID: true
    containers:
      - name: zabbix-agent
        image: tristar:5000/zabbix-agent:latest
        ports:
          - {containerPort: 10050}
        imagePullPolicy: Always
        env:
          - {name: ZABBIX_SERVER, value: zabbix}
          - {name: TZ, value: EST}

  - name: docker-gc
    containers:
      - name: gc
        image: tristar:5000/gc:latest
        env:
          - {name: TZ, value: EST}
        volumeMounts:
          - {name: docker,  mountPath: /var/run/docker.sock}
    volumes:
      - name: docker
        hostPath:
          path: /var/run/docker.sock

services:
  - name: registry
    ports:
      - port: 5000
    nodeSelector:
      host: tristar
    annotations:
      nginx:
        - http:
          - server: default
            locations:
              - /v2
      icon: https://avatars2.githubusercontent.com/u/5429470?v=3&s=200
    strategy: RollingUpdate
    volumes:
      - {name: registry, hostPath: {path: '/root/docker-registry/data2'}}
    containers:
      - name: registry
        image: registry:2
        imagePullPolicy: Always
        ports:
          - {containerPort: 5000, hostPort: 5000}
        volumeMounts:
          - {name: registry, mountPath: /var/lib/registry}

  - name: knginx
    ports:
      - {port: 80, name: http}
      - {port: 443, name: https}
    nodeSelector:
      host: tristar
    annotations:
      icon: http://nginx.org/nginx.png
    strategy: RollingUpdate
    containers:
      - name: knginx
        image: tristar:5000/knginx:latest
        imagePullPolicy: Always
        ports:
          - {containerPort: 80,    hostPort: 80}
          - {containerPort: 443,    hostPort: 443}
          - {containerPort: 25565, hostPort: 25565}
          - {containerPort: 25566, hostPort: 25566}
        readinessProbe:
          httpGet:
            path: /lb-status
            port: 80
          initialDelaySeconds: 30
        volumeMounts:
          - {name: cert, mountPath: /etc/nginx/ssl/server.crt}
          - {name: key,  mountPath: /etc/nginx/ssl/server.key}
        env:
          - {name: PAGESPEED, value: "on"}
    volumes:
      - {name: cert, hostPath: {path: /etc/letsencrypt/live/rebelsoft.com/fullchain.pem}}
      - {name: key,  hostPath: {path: /etc/letsencrypt/live/rebelsoft.com/privkey.pem}}

  - name: letsencrypt
    ports:
      - port: 80
    nodeSelector:
      host: tristar
    annotations:
      nginx:
        - http:
          - server: default
            locations:
              - /.well-known
      icon: https://avatars2.githubusercontent.com/u/9289019?v=3&s=200
    strategy: RollingUpdate
    containers:
      - name: letsencrypt
        image: tristar:5000/letsencrypt:latest
        imagePullPolicy: Always
        env:
          - {name: DOMAINS, value: "{{ letsencrypt_domains }}"}
          - {name: EMAIL, value: "{{ letsencrypt_email }}"}
        volumeMounts:
          - {name: letsencrypt, mountPath: /etc/letsencrypt}
    volumes:
      - name: letsencrypt
        hostPath:
          path: /etc/letsencrypt

  - name: kubernetes-ui
    ports:
      - port: 8000
    nodeSelector:
      zone: green
    annotations:
      nginx:
        - http:
          - server: kubernetes.*
            locations:
              - /kubernetes-ui
          - server: default
            locations:
              - /kubernetes-ui
      depends: [kubernetes]
    strategy: RollingUpdate
    containers:
      - name: kubernetes-ui
        image: tristar:5000/kubernetes-ui:latest
        imagePullPolicy: Always
        env:
          - {name: KUBECTL, value: "http://{{ ETCD_HOST }}:3000"}
          - {name: KMASTER, value: "http://{{ ETCD_HOST }}:8080"}

  - name: springboot
    ports:
      - {port: 8080, name: springboot}
      - {port: 10050, name: agent}
    annotations:
      nginx:
        - http:
          - server: springboot.*
            locations:
              - /
    replicas: 1
    strategy: RollingUpdate
    containers:
      - name: sprintboot
        image: tristar:5000/springboot:latest
        imagePullPolicy: Always
      - name: zabbix-agent
        image: tristar:5000/zabbix-agent:latest
        imagePullPolicy: Always
        env:
          - {name: ZABBIX_SERVER, value: zabbix}
          - {name: HOSTMETADATA, value: springboot}

  - name: kafka-manager
    ports:
      - port: 9000
    nodeSelector:
      zone: green
    annotations:
      nginx:
        - http:
            - server: kafka-manager.*
              locations:
                - /
      depends: [kafka]
      group: rtail
    strategy: RollingUpdate
    containers:
      - name: kafka-manager
        image: tristar:5000/kafka-manager:latest
        imagePullPolicy: Always
        env:
          - {name: ZK_HOSTS, value: "zookeeper:2181"}

  - name: mongodb
    ports:
      - port: 27017
    nodeSelector:
      zone: green
    annotations:
      icon: "https://avatars3.githubusercontent.com/u/45120?v=3&s=200"
    strategy: RollingUpdate
    containers:
      - name: mongodb
        image: tristar:5000/mongodb:latest
        imagePullPolicy: Always

  - name: gitlab
    ports:
      - {port: 80, name: http}
    nodeSelector:
      zone: green
    annotations:
      nginx:
        - http:
            - server: gitlab.*
              locations:
                - /
    strategy: RollingUpdate
    containers:
      - name: gitlab
        image: gitlab/gitlab-ce:latest
        imagePullPolicy: Always

  - name: kafka
    ports:
      - {port: 9092, name: kafka}
      - {port: 9999, name: jmx}
    nodeSelector:
      zone: green
    annotations:
      icon: http://kafka.apache.org/images/kafka_logo.png
      depends: [zookeeper]
      group: rtail
    strategy: RollingUpdate
    containers:
      - name: kafka
        image: tristar:5000/kafka:latest
        imagePullPolicy: Always
        env:
          - {name: ZOOKEEPER_HOST,  value: "zookeeper"}
          - {name: JMX_PORT,        value: "9999"}
          - {name: LOG_RETENTION_HOURS, value: "1"}
          - {name: LOG_RETENTION_BYTES, value: "1048576"}

  - name: redis
    ports:
      - port: 6379
    nodeSelector:
      host: nuc1
    volumes:
      - {name: ssh-keys, secret: {secretName: ssh-key-secret}}
    strategy: RollingUpdate
    replicas: 0
    containers:
      - name: redis
        image: tristar:5000/redis:latest
        imagePullPolicy: Always
        volumeMounts:
          - {name: ssh-keys, mountPath: /etc/ssh-keys, readOnly: true}

  - name: zookeeper
    ports:
      - port: 2181
    nodeSelector:
      zone: green
    annotations:
      icon: https://zookeeper.apache.org/images/zookeeper_small.gif
      group: rtail
    strategy: RollingUpdate
    containers:
      - name: zookeeper
        image: tristar:5000/zookeeper:latest
        imagePullPolicy: Always

  - name: elasticsearch
    ports:
      - port: 9200
    nodeSelector:
      zone: green
    annotations:
      nginx:
        - http:
            - server: elasticsearch.*
              locations:
                - /
      group: rtail
    strategy: RollingUpdate
    containers:
      - name: elasticsearch
        image: tristar:5000/elasticsearch:latest
        imagePullPolicy: Always
        readinessProbe:
          httpGet:
            path: /
            port: 9200
          initialDelaySeconds: 30
        env:
          - {name: CLUSTER_NAME, value: LOGS}

  - name: kibana
    ports:
      - port: 5601
    nodeSelector:
      zone: green
    annotations:
      nginx:
        - http:
            - server: kibana.*
              locations:
                - /
      depends: [elasticsearch]
    strategy: RollingUpdate
    containers:
      - name: kibana
        image: tristar:5000/kibana:latest
        imagePullPolicy: Always
        readinessProbe:
          httpGet:
            path: /
            port: 5601
          initialDelaySeconds: 30
        env:
          - {name: ELASTICSEARCH_HOST, value: elasticsearch}

  - name: uptime
    ports:
      - port: 8082
    nodeSelector:
      zone: green
    annotations:
      nginx:
        - http:
            - server: uptime.*
              locations:
                - /
    strategy: RollingUpdate
    containers:
      - name: uptime
        image: tristar:5000/uptime:latest
        imagePullPolicy: Always

  - name: prometheus
    ports:
      - port: 9090
    nodeSelector:
      zone: green
    annotations:
      nginx:
        - http:
            - server: prometheus.*
              locations:
                - /
      icon: "https://avatars3.githubusercontent.com/u/3380462?v=3&s=200"
      depends: [pushgateway]
      group: prometheus
    strategy: RollingUpdate
    containers:
      - name: prometheus
        image: tristar:5000/prometheus:latest
        imagePullPolicy: Always

  - name: keycloak
    ports:
      - port: 8080
    nodeSelector:
      zone: green
    annotations:
      nginx:
        - http:
            - server: keycloak.*
              locations:
                - /
      icon: https://pbs.twimg.com/profile_images/428872865031536641/LMjCu1H7_400x400.png
    strategy: RollingUpdate
    containers:
      - name: keycloak
        image: tristar:5000/keycloak:latest
        imagePullPolicy: Always

  - name: packetbeat
    ports:
      - {port: 5601, name: kibana}
      - {port: 9200, name: elasticsearch}
    nodeSelector:
      zone: green
    annotations:
      nginx:
        - http:
            - server: packetbeat.*
              locations:
                - /
    strategy: RollingUpdate
    containers:
      - name: packetbeat
        image: tristar:5000/packetbeat:latest
        imagePullPolicy: Always
        readinessProbe:
          httpGet:
            path: /
            port: 9200
          initialDelaySeconds: 30

  - name: odoo
    ports:
      - port: 8069
    nodeSelector:
      zone: green
    annotations:
      nginx:
        - http:
            - server: odoo.*
              locations:
                - /
    strategy: RollingUpdate
    containers:
      - name: odoo
        image: tristar:5000/odoo:latest
        imagePullPolicy: Always

#  - name: openproject
#    ports:
#      - port: 3000
#    annotations:
#      nginx:
#        - http:
#            - server: openproject.*
#              locations:
#                - /
#    strategy: RollingUpdate
#    containers:
#      - name: openproject
#        image: tristar:5000/openproject:latest
#        imagePullPolicy: Always
#        <<: *log-mount
#      - <<: *fluentd
#        env:
#          - <<: *zookeeper-host
#          - {name: LABEL, value: OPENPROJECT}
#    <<: *log-volume

  - name: minecraft
    ports:
      - {port: 25565, name: minecraft}
      - {port: 9001,  name: fontail}
    nodeSelector:
      zone: green
    annotations:
      nginx:
        - http:
          - server: minecraft.*
            port: 9001
            locations:
              - /
        - stream:
            - listen: 25565
      icon: http://images.wikia.com/yogbox/images/d/dd/Minecraft_Block.svg
    strategy: RollingUpdate
    containers:
      - name: minecraft
        image: tristar:5000/minecraft:latest
        imagePullPolicy: Always

  - name: jenkins
    ports:
      - {port: 8080, name: http}
      - {port: 8081, name: slave}
    annotations:
      nginx:
        - http:
          - server: jenkins.*
            locations:
              - /jenkins
      icon: https://jenkins-ci.org/images/logo_head.png
      depends: [jenkins-swarm-client]
      group: jenkins
    nodeSelector:
      host: tristar
    strategy: RollingUpdate
    containers:
      - name: jenkins
        image: tristar:5000/jenkins:latest
        imagePullPolicy: Always
        env:
          - {name: KMASTER, value: "{{ ETCD_HOST }}"}
          - {name: TZ, value: EST}
        volumeMounts:
          - {name: jenkins, mountPath: /root/.jenkins}
          - {name: docker,  mountPath: /var/run/docker.sock}
    volumes:
      - name: jenkins
        hostPath:
          path: '/root/docker-jenkins/jenkins'
      - name: docker
        hostPath:
          path: /var/run/docker.sock

  - name: jenkins-swarm-client
    ports:
      - {port: 8080, name: http}
    annotations:
      group: jenkins
    nodeSelector:
      zone: green
    strategy: RollingUpdate
    containers:
      - name: jenkins-swarm-client
        image: tristar:5000/jenkins-swarm-client:latest
        imagePullPolicy: Always
        volumeMounts:
          - {name: docker,  mountPath: /var/run/docker.sock}
        env:
          - {name: MASTER, value: "http://jenkins:8080/jenkins/"}
          - {name: USERNAME, value: "{{ jenkins_username }}"}
          - {name: PASSWORD, value: "{{ jenkins_password }}"}
          - {name: REGISTRY, value: "tristar:5000"}
          - {name: http_proxy, value: "http://ivy:3128"}
          - {name: https_proxy, value: "http://ivy:3128"}
    volumes:
      - name: docker
        hostPath:
          path: /var/run/docker.sock

  - name: zabbix
    ports:
      - {port: 80, name: web}
      - {port: 10051, name: zabbix}
    annotations:
      nginx:
        - http:
          - server: zabbix.*
            locations:
              - /
      icon: http://www.zabbix.com/img/logo/zabbix_logo_500x131.png
      group: zabbix
      depends: [zabbix-db]
    nodeSelector:
      host: tristar
    strategy: RollingUpdate
    containers:
      - name: zabbix
        image: tristar:5000/zabbix:latest
        imagePullPolicy: Always
        env:
          - {name: ZABBIX_DB, value: zabbix-db}

  - name: zabbix-db
    ports:
      - {port: 80, name: web}
      - {port: 3306, name: mysql}
    annotations:
      nginx:
        - http:
          - server: zabbix-db.*
            locations:
              - /
      icon: https://www.mysql.com/common/logos/logo-mysql-170x115.png
      group: zabbix
    nodeSelector:
      host: tristar
    strategy: RollingUpdate
    containers:
      - name: zabbix-db
        image: tristar:5000/zabbix-db:latest
        imagePullPolicy: Always
        volumeMounts:
          - {name: data, mountPath: /var/lib/mysql}
    volumes:
      - name: data
        hostPath:
          path: '/root/zabbix-data'

  - name: rundeck
    ports:
      - {port: 8080, name: rundeck}
      - {port: 10050, name: agent}
    annotations:
      nginx:
        - http:
          - server: rundeck.*
            locations:
              - /
    strategy: RollingUpdate
    containers:
      - name: rundeck
        image: tristar:5000/rundeck:latest
        imagePullPolicy: Always
      - name: zabbix-agent
        image: tristar:5000/zabbix-agent:latest
        imagePullPolicy: Always
        env:
          - {name: ZABBIX_SERVER, value: zabbix}
          - {name: HOSTMETADATA, value: springboot}

  - name: pushgateway
    ports:
      - port: 9091
    nodeSelector:
      zone: green
    annotations:
      metrics: /metrics
      group: prometheus
    strategy: RollingUpdate
    containers:
      - name: pushgateway
        image: prom/pushgateway
        imagePullPolicy: Always

  - name: rtail
    ports:
      - port: 8888
    nodeSelector:
      zone: green
    annotations:
      nginx:
        - http:
            - server: rtail.*
              locations:
                - /
      depends: [kafka, zookeeper, elasticsearch]
      group: rtail
    strategy: RollingUpdate
    containers:
      - name: rtail
        image: tristar:5000/rtail:latest
        imagePullPolicy: Always

  - name: httpbin
    ports:
      - port: 5000
    nodeSelector:
      zone: green
    annotations:
      nginx:
        - http:
            - server: httpbin.*
              locations:
                - /
              port: 80
    strategy: RollingUpdate
    containers:
      - name: httpbin
        image: tristar:5000/httpbin:latest
        imagePullPolicy: Always

  - name: graylog
    ports:
      - port: 80
        name: web-interface
      - port: 514
        name: syslog-tcp
      - port: 5555
        name: raw-tcp
      - port: 12201
        name: gelf-tcp
      - port: 12201
        name: gelf-udp
        protocol: UDP
      - port: 12900
        name: graylog
    annotations:
      nginx:
        - http:
            - server: graylog.*
              locations:
                - /
    <<: *green
    replicas: 1
    strategy: RollingUpdate
    containers:
      - name: graylog
        image: tristar:5000/graylog:latest
        imagePullPolicy: Always
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 30

  - name: wiremock
    ports:
      - port: 8080
    nodeSelector:
      zone: green
    annotations:
      nginx:
        - http:
            - server: wiremock.*
              locations:
                - /
    strategy: RollingUpdate
    containers:
      - name: wiremock
        image: tristar:5000/wiremock:latest
        imagePullPolicy: Always

  - name: zipkin
    ports:
      - {name: http, port: 8080}
      - {name: scribe, port: 1463}
    nodeSelector:
      zone: green
    annotations:
      nginx:
        - http:
            - server: zipkin.*
              locations:
                - /
      icon: https://raw.githubusercontent.com/openzipkin/zipkin/master/doc/zipkin-logo-200x119.jpg
    strategy: RollingUpdate
    containers:
      - name: zipkin
        image: tristar:5000/zipkin:latest
        imagePullPolicy: Always

  - name: squid
    ports:
      - port: 8080
    nodeSelector:
      zone: green
    annotations:
      nginx:
        - http:
            - server: squid.*
              locations:
                - /
    strategy: RollingUpdate
    containers:
      - name: squid
        image: tristar:5000/squid:latest
        imagePullPolicy: Always

  # - name: gocd
  #   ports:
  #     - port: 8153
  #   annotations:
  #     nginx:
  #       - http:
  #         - server: default
  #           locations:
  #             - /go
  #   nodeSelector:
  #     kubernetes.io/hostname: 192.168.1.160
  #   strategy: RollingUpdate
  #   containers:
  #     - name: gocd
  #       image: goserver:latest
  #       imagePullPolicy: Never
  #       volumeMounts:
  #         - {name: go,       mountPath: /etc/go}
  #         - {name: goserver, mountPath: /etc/default/go-server}
  #         - {name: goagent,  mountPath: /etc/default/go-agent}
  #         - {name: db,       mountPath: /var/lib/go-server/db}
  #         - {name: docker,   mountPath: /var/run/docker.sock}
  #   volumes:
  #     - name: go
  #       hostPath:
  #         path: /root/docker-gocd/etc/go
  #     - name: goserver
  #       hostPath:
  #         path: /root/docker-gocd/etc/default/go-server
  #     - name: goagent
  #       hostPath:
  #         path: /root/docker-gocd/etc/default/go-agent
  #     - name: db
  #       hostPath:
  #         path: /root/docker-gocd/db
  #     - name: docker
  #       hostPath:
  #         path: /var/run/docker.sock

  # - name: ceph-mon-tristar
  #   ports:
  #     - {name: mon, port: 6789}
  #   nodeSelector:
  #     host: tristar
  #   containers:
  #     - name: ceph-mon
  #       image: "ceph/daemon"
  #       imagePullPolicy: Always
  #       env:
  #         - {name: CEPH_DAEMON, value: mon}
  #         - {name: CEPH_PUBLIC_NETWORK, value: "10.244.0.0/16"}
  #         - {name: MON_IP_AUTO_DETECT, value: "1"}
  #       volumeMounts:
  #         - {name: etc-ceph, mountPath: /etc/ceph}
  #         - {name: var-lib-ceph, mountPath: /var/lib/ceph}
  #   volumes:
  #     - name: etc-ceph
  #       hostPath:
  #         path: /etc/ceph
  #     - name: var-lib-ceph
  #       hostPath:
  #         path: /var/lib/ceph
